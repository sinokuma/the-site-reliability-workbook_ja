# EvernoteのSLOストーリー

by Ben McCormack, Evernote

Evernoteは、個人やチームが情報を作成し、集めて、共有するのに役立つクロスプラットフォームのアプリです。
世界中に2億2000万人以上のユーザーがいる私たちは、プラットフォーム内に、テキストベースのメモ、ファイル、添付ファイル/画像を組み合わせた120億を超える情報を保存しています。
裏では、Evernoteサービスは750以上のMySQLインスタンスによって支えられています。

サービス品質を維持しながらエンジニアリングのスピードを向上させることを目的とした、これまでよりも広範な技術改善の一環としてSLOの概念をEvernoteに導入しました。
我々の目標には以下のようなものが含まれます。

* データセンターにおける差別化されない過重負荷から、顧客が実際に気にしているプロダクトエンジニアリング作業にエンジニアリングの焦点を移します。そのために、私たちは物理的なデータセンターの運用をやめ、パブリッククラウドに移行しました。
* 全体的なサービス品質を維持しつつ、機能のベロシティ向上をサポートするために、運用およびソフトウェアエンジニアのワーキングモデルを変えてください。
* 障害が我々の大規模でグローバルな顧客基盤にどのように影響するかということに確実に焦点を絞るために、SLAの見方を見直してください。

これらの目標は、多くの業界の組織にとって馴染みのあるものに見えるかもしれません。
これらの類の変更を行うための単一のアプローチが全面的に機能することはありませんが、我々の経験を共有することで、同様の課題に直面している他のユーザにとって有益な洞察が得られることを願っています。

## なぜEvernoteはSREモデルを採用したのか

この移行を始めた時、Evernoteは従来のops/dev分離を特徴としていました。運用チームはプロダクション環境の尊厳を保護し、一方で開発チームは顧客向けの新しいプロダクト機能の開発を任されていました。
これらの目的はいつも競合していました。開発チームは長い運用要件に制限されていると感じている一方で、運用チームは新しいコードによってプロダクション環境に新しい問題が混入されると苛立っていました。
この2つの目標の間で激しく揺れ動いたため、opsチームとdevチームの間には苛立ちや緊張関係が築かれてしまいました。
私たちは、関係するチームのさまざまなニーズをよりバランス良く満たす、より幸せな伝達手段に到達したいと考えました。

私たちは5年以上にわたって様々な方法でこの伝統的な二分法におけるギャップを解決しようとしました。
「あなたが書いた、あなたが実行した」(開発)モデル、そして「あなたが書いた、我々があなたのために実行する」(運用)モデルを試した後、SLO中心のSREアプローチに移行しました。

では、Evernoteがこの方針に向く動機は何だったのでしょうか。

Evernoteでは、運用と開発の中核となる規律をエンジニアが専門とすることができる個別の専門的な筋道として捉えています。
1つの筋道は、顧客への24時間365日の継続的なサービス提供に関係しています。
もう1つは、将来の顧客ニーズを満たすためのサービス拡張と進化に関するものです。
SREやDevOpsがソフトウェア開発を運用に適用することに重点を置くような動きと同様に、これら2つの規律は近年互いに歩み寄っています。(この収束は、データセンター自動化とパブリッククラウドの成長によって促進されており、これら双方によってソフトウェアによって完全に制御されたデータセンターがもたらされます。)
その一方で、フルスタックの所有権と継続的デプロイがソフトウェア開発にますます適用されています。

チームが共通の目標に向かって作業することを奨励しながら、運用と開発の違いを完全に受け入れるため、我々はSREモデルに惹かれました。
SREモデルは、運用エンジニアをアプリケーション開発者に、またはその逆に変換しようとはしません。
その代わり、両方に共通の基準を与えます。
私たちの経験上、エラー・バジェット/SLOのアプローチは会話から主観性の多くを排除するので、同じ事実が提示されたときに両方のチームが同じような決定を下すようになりました。

## SLOの導入：発展の道のり

私たちの旅の最初のパートは、物理データセンターからGoogle Cloud Platformへの移行でした。【1】
EvernoteサービスがGCP上で稼働し安定した後に、SLOを導入しました。
ここでの目標は2つありました。

* Evernote SLO内部にチームを配置し、すべてのチームが新しいフレームワークの中で作業していることを確認する。
* 根底にあるインフラストラクチャを担当していたGoogle Cloudチームとの連携手段にEvernoteのSLOを組み込みます。私たちは現在、全体的なモデルの中に新しいパートナーを持っていたので、GCPへの移行がユーザへのコミットメントを希薄にしたり、隠蔽したりしないようにする必要がありました。

およそ9か月間にわたってSLOを積極的に使用した後、EvernoteではSLOプラクティスが既にバージョン3になっています。

SLOの技術的な詳細に入る前に、顧客の観点から会話を始めることが重要です。
あなたはどんな約束を守ろうとしていますか。
多くのサービスと同様に、Evernoteには、ユーザが沢山の独創的な方法で使用するために用意した多くの機能とオプションがあります。
我々は最初に最も重要で共通の顧客ニーズに集中することを確実にしたいと考えました。それは、ユーザが複数クライアント横断的に自分のコンテンツにアクセスし同期するEvernoteサービスの可用性です。
私たちのSLOの旅はその目標から始まりました。
稼働時間に重点を置くことで、最初のパスをシンプルにしました。
このシンプルな最初のアプローチを使用して、私たちは何をどのように測定していたのかを明確にすることができました。

最初のSLO文書には、以下のものが含まれていました。

_SLO定義_  
これは稼働時間の尺度でした。99.95％の稼働時間が月次ウィンドウで測定され、特定のサービスおよびメソッドに対して設定されています。
この数字は、社内のカスタマーサポートチームおよびプロダクトチームとの議論と、より重要なのですが、ユーザからのフィードバックに基づいて選択しました。
我々はサービスレビューを実施するときに集中しつつ、きちんと整理し続けるために、SLOをカレンダー月とローテーション期間の間に限定することを意図的に選択しました。

_何を計測するか、そしてそれをどう計測するか_  
_何を計測するか_  
私たちはサービスが期待どおりに機能しているかどうかをテストするために呼び出すことができるサービスエンドポイントを指定しました。
私たちの場合、サービスに組み込まれたステータスページを使って、スタックの大部分を検証し、問題なければステータスコード200を返します。

_どう計測するか_  
ステータスページを定期的に呼び出すプローバが必要でした。
負荷分散スタックを含むすべてのコンポーネントをテストできるように、そのプローバを完全に環境の外側に配置し、環境から独立させたかったのです。
ここでの目標は、GCPサービスとEvernoteアプリケーションの両方の障害をすべて確実に測定していることです。
しかし、我々はランダムなインターネットの問題が誤検知を引き起こすことを望みませんでした。
そのようなプローバの構築と運営を専門とするサードパーティ会社を使用することを選択しました。
Pingdomを選択しましたが、市場には他にもたくさんあります。
以下のように測定を行います。

* **プローブ頻度**：毎分フロントエンドノードをポーリングします。
* **プローバの配置場所**：この設定は変更可能です。現在、北米とヨーロッパで複数のプローブを使用しています。
* **「停止」の定義**：プローバチェックが失敗した場合、ノードは未確認のダウンとしてマークされ、その後地理的に離れた別のプローバがチェックを実行します。2番目のチェックが失敗すると、ノードはSLO計算目的でダウン中であるとマークされます。 連続したプローブ要求がエラーを登録する限り、ノードは引き続きダウン中であるとマークされます。

_モニタリングデータからどの良いうにSLOを計算するか_  
最後に、Pingdomから受け取った生データからSLOを計算する方法を慎重に文書化しました。
例えば、メンテナンス期間の計算方法を指定しました。数億人のユーザ全員が公開されたメンテナンス期間について知っているとは限りません。それ故、知らないユーザはこれらの期間を一般的かつ説明のつかないダウンタイムであるものとして過ごすことになるため、SLOの計算ではメンテナンスをダウンタイムとして扱いました。

SLOを定義したら、それを使って何かをしなければなりませんでした。
私たちは、SLOが顧客をより幸せにし、幸せに保つためのソフトウェアと運用の変更を推進したいと思っていました。
これをするためにどうすればベストでしょうか。

----------
【1】しかし、それは別の本の話です。詳細については、[http://bit.ly/2spqgcl](http://bit.ly/2spqgcl)を参照してください。
