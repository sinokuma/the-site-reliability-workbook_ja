# Home DepotのSLOストーリー

by William Bonnell, The Home Depot

ホームデポ(THD)は、世界最大のホームセンターの小売業者です。北米各地に2,200以上の店舗があり、それぞれ35,000以上のユニークな商品で構成されています(そしてオンラインで150万以上の商品が供給されています)。
当社のインフラストラクチャは、400,000人近くの従業員をサポートし、年間15億以上の顧客取引を処理するさまざまなソフトウェアアプリケーションをホストしています。
これらの店舗は、世界規模のサプライチェーンおよび年間20億回以上の訪問を受けるeコマースWebサイトと緊密に統合されています。

ソフトウェア開発のスピードと品質を高めることを目的とした最近のオペレーションアプローチの更新により、THDはアジャイルソフトウェア開発に焦点を合わせ、ソフトウェアの設計と管理方法を変更しました。
私たちは、大規模なモノリシックソフトウェアパッケージをサポートする中央集権型のサポートチームから、小規模で独立して運営されるソフトウェア開発チームによるマイクロサービスアーキテクチャへと移行しました。
その結果、私たちのシステムには常に、絶えず変化するソフトウェアの小さな塊があり、それらもスタック全体に統合する必要がありました。

マイクロサービスへの移行は、フルスタックオーナーシップの新しい「自由と責任の文化」への移行によって補完されました。
このアプローチにより、開発者は必要なときに自由にコードをプッシュすることができますが、同時にサービスの運用に対して共同で責任を負うことになります。
この共有オーナーシップモデルが機能するためには、運用チームと開発チームが、説明責任を促進し、複雑さを乗り越えるための共通言語、つまりサービスレベル目標を話す必要があります。
互いに依存しているサービスは、次のような情報を知る必要があります。

* あなたのサービスはどの程度信頼できますか？それは、3ナイン、3.5ナイン、または4ナイン(またはそれ以上)を目標に構築されていますか？計画的な停止時間はありますか？
* 上限に達すると、どのようなレイテンシが予想されますか？
* これから送ろうとしている大量のリクエストを処理できますか。どのように過負荷状態を処理しますか？サービスは時間の経過とともにSLOを達成しましたか？

すべてのサービスがこれらの質問に対する透過的で一貫した回答を提供できる場合、チームは依存関係を明確に把握できるため、チーム間のコミュニケーションが向上し、信頼性と説明責任が向上します。

## SLO文化プロジェクト

このサービスモデルの移行を始める前は、ホームデポにはSLOの文化はありませんでした。
監視ツールやダッシュボードは豊富でしたが、あちこちに散らばっていて、時間の経過とともにデータを追跡することはできませんでした。
特定の機能停止の根本にあるサービスを特定できるとは限りませんでした。
多くの場合、私たちはユーザに面しているサービスからトラブルシューティングを始め、問題が見つかるまでバックエンド方向に作業し、無数の時間を無駄にしました。
サービスに計画的な停止時間が必要な場合、その依存サービスは驚くべきものでした。
チームが3.5ナインのサービスを構築する必要がある場合、依存しているサービスがより優れた稼働時間(4ナイン)でそれらをサポートできるかどうかはわかりません。
これらの断絶は、当社のソフトウェア開発チームと運用チームの間で混乱と失望を引き起こしました。

私たちはSLOの共通文化を築くことによってこれらの断絶に対処する必要がありました。
そのためには、人、プロセス、およびテクノロジに影響を及ぼすための包括的な戦略が必要でした。
4つの一般的な分野について我々は努力しました。

_共通的な専門用語_  
THDのコンテキストでSLOを定義します。それらを一貫した方法で測定する方法を定義します。

_エヴァンジェリズム_  
用語を全社に広めてください。

* SLOが重要な理由、社内でのロードショー、社内ブログ、Tシャツやステッカーなどの宣伝材料を販売するためのトレーニング資料を作成します。
* SLOを実装し、他者への価値を実証するために、何人か早期導入者を参加させます。
* アイデアを広めるために、わかりやすい略語(VALET:後述)を設定します。
* SLOやその他信頼性の概念について開発者をトレーニングするための訓練プログラム(FiRE Academy:信頼性エンジニアリングの基礎)を作成します。【2】

_自動化_  
導入の煩わしさを軽減するために、本番環境にデプロイされたサービスのサービスレベル指標を自動的に収集するメトリック収集プラットフォームを実装します。これらのSLIは後でより簡単にSLOに変えることができます。

_インセンティブ_  
すべての開発管理者が自分たちのサービスのSLOを設定し、測定するための年間目標を立てます。

共通の用語を確立することは、全員を同じページに参加させるために必要不可欠でした。
私たちはまた、このフレームワークをできるだけシンプルにして、アイデアをより早く広めることを目指しました。
はじめに、さまざまなサービスにわたって監視している指標を批判的に調べたところ、いくつかのパターンを見つけました。
すべてのサービスは、何らかの形でトラフィック量、レイテンシ、エラー、利用率を監視していました。これは、Google SREの[Four Golden Signals](http://bit.ly/2LSLpDQ)と密接に関連しています。
さらに、多くのサービスでは、稼働時間や可用性をエラーとは区別して監視していました。
残念ながら、全体的に見て、すべてのカテゴリのメトリクスが一貫性のない方法で監視されているか、名前が異なるか、データが不十分でした。

私たちのサービスのどれもSLOを持っていませんでした。
私たちの本番システムが顧客向けのSLOに最も近いメトリックはサポートチケットでした。
店舗にデプロイされているアプリケーションの信頼性を測定するための主な(そして大抵は唯一の)方法は、社内のサポートデスクが受けたサポートコールの数を追跡することでした。

## 最初のSLO

測定可能なシステムのあらゆる側面に対してSLOを作成することはできませんでした。そのため、どのメトリクスまたはSLIにもSLOを含めるべきかを決定する必要がありました。

### APIコールの可用性とレイテンシ

各マイクロサービスは、他のマイクロサービスからのAPIコールに対して可用性とレイテンシのSLOを持つ必要があると判断しました。
たとえば、カートマイクロサービスは在庫マイクロサービスに呼ばれていました。
これらのAPIコールについて、カートマイクロサービス(および在庫を必要とするその他のマイクロサービス)が、在庫マイクロサービスが自身の信頼性要件を満たすことができるかどうかを判断するためのSLOを在庫マイクロサービスが公開しました。

### インフラ使用率

THDのチームは様々な方法でインフラストラクチャ使用率を測定しますが、最も一般的な測定は1分単位でのリアルタイムインフラストラクチャ使用率です。
いくつかの理由で、使用率SLOの設定に反対しました。
はじめに、マイクロサービスはこの測定基準に過度には関心を寄せていません。トラフィック量を処理できている、マイクロサービスが起動している、即時にレスポンスしている、エラーを投げていない、キャパシティ不足の危険にさらされていない限り、ユーザは使用率を気にする必要はありません。
さらに、近い将来のクラウド移行により、利用率はそれほど問題にならなくなるため、コスト計画によってキャパシティ計画が覆い隠されることになります。(使用率を監視してキャパシティプランニングを実行する必要がありますが、それをSLOフレームワークに含める必要はありませんでした。)

### トラフィック量

THDにはキャパシティプランニングの文化がまだなかったので、私たちは彼らのサービスが処理できる量を伝えるためのソフトウェアと運用チーム向けのメカニズムが必要でした。
トラフィックは、サービスへのリクエストであるとして定義するのは簡単でしたが、1秒あたりの平均リクエスト数、1秒あたりのピークリクエスト数、またはレポート期間中のリクエスト量を追跡するかどうかを決定する必要がありました。
3つすべてを追跡し、各サービスに最も適切なメトリックを選択することにしました。
このメトリックは、制御可能な内部要因ではなくユーザの行動によって決定されるため、トラフィック量にSLOを設定するかどうかを検討しました。
最終的に、小売業者としてブラックフライデーのようなピークに合わせてサービスをサイジングする必要があると判断したため、予想されるピークキャパシティに従ってSLOを設定しました。

### レイテンシ

各サービスにレイテンシのSLOを定義させ、どこで測定するのが最適かを決定します。
私たちの唯一の要求は、ネットワークやキャッシュやプロキシのようなマイクロサービスの外側で失敗する他のレイヤによって引き起こされる問題を捉えるために、サービスがブラックボックス監視で一般的なホワイトボックスパフォーマンス監視を補うべきであるということでした。
また、パーセンタイルは算術平均よりも適切であると判断しました。
少なくとも、サービスは90パーセンタイルの目標を達成する必要がありました。ユーザ向けサービスでは、95パーセンタイルまたは99パーセンタイル、あるいはその両方を優先的な目標としていました。

### エラー

エラーを説明するのはやや複雑でした。
私たちは主にWebサービスを扱っていたので、エラーを構成する要素とエラーを返す方法を標準化する必要がありました。
Webサービスにエラーが発生した場合は、当然ながらHTTPレスポンスコードで標準化されています。

* サービスは、2xx応答の本文にエラーを示すべきではありません。むしろ、それは4xxか5xxを投げるべきです。
* サービスの問題(例えばメモリ不足)が原因で発生したエラーは、5xxエラーをスローすべきです。
* クライアントによって引き起こされたエラー(例えば、不正なリクエスト送信)は、4xxエラーをスローすべきです。

十分に検討した結果、4xxと5xxの両方のエラーを追跡することにしましたが、5xxエラーはSLOを設定するためだけに使用しました。
他のSLO関連要素に対する私たちのアプローチと同様に、私たちはこのディメンションを一般的なものにして、異なるアプリケーションが異なるコンテキストにそれを利用できるようにしました。
例えば、HTTPエラーに加えて、バッチ処理サービスのエラーは、処理に失敗したレコード数になるでしょう。

### チケット

前述したように、チケットは元々私たちのプロダクションソフトウェアの大部分を評価する主な方法でした。
歴史的な理由から、私たちは他のSLOと一緒にチケットを追跡し続けることにしました。
このメトリックは、「ソフトウェア運用レベル」のようなものと同類と考えることができます。

### VALET

私達は新しいSLOを便利な略語にまとめました：VALETです。

_Volume(traffic)_  
サービスはどのくらいのビジネス量を扱うことができますか？

_Availability_  
必要なときにサービスは起動していますか？

_Latency_  
使用したときにサービスが高速に応答しますか？

_Errors_  
サービスを使用するとエラーが発生しますか？

_Tickets_  
サービスは私の要求を完了するために手作業の介入が必要ですか？

## SLOを伝道する

覚えやすい略語で武装して、私たちは企業にSLOを伝道することに着手しました。

* なぜSLOが重要なのか
* SLOが私たちの「自由と責任」文化をどのように支えているか
* 何を計測すべきか
* 結果に対して何をするか

開発者がソフトウェア運用を担当するようになったため、信頼性の高いソフトウェアを構築およびサポートする能力を実証し、顧客向けサービスについてサービス消費者およびプロダクトマネージャとコミュニケーションを取るためのSLOを確立する必要がありました。
しかし、オーディエンスの大半はSLAやSLOのような概念に精通していなかったので、彼らはこの新しいVALETフレームワークについて教育を受ける必要がありました。

SLOへの移行のためにエグゼクティブの後押しを勝ち取る必要があったため、私たちの教育キャンペーンは上級管理職から始まりました。
その後、開発チームと1人ずつ会ってSLOの価値を高めました。
私たちは、チームが彼らのカスタムメトリクス追跡メカニズム(大抵は手動)からVALETフレームワークへ移行することを推奨しました。
その勢いを継続させるために、私たちは週に1回のSLOレポートをVALETフォーマットで送りました。また、一般的な信頼性の概念と社内イベントから学んだ教訓についての上級管理者向けの解説を組み合わせました。
これは、作成された購買発注(量)や処理に失敗した購買発注(エラー)などのビジネス指標をVALETの観点から評価するのにも役立ちました。

私達はさらに伝道を色々な方法で拡大しました。

* VALETと信頼性に関するブログをホストするため、内部のWordPressサイトを開設し、有用なリソースをリンクしました。
* 一般的な信頼性の概念とVALETによる測定方法を議論するために、社内のテクニカルトーク(Google SREゲストスピーカー含む)を行いました。
* 私達は一連のVALETトレーニングワークショップ(後にFiREアカデミーに発展)を実施して、参加希望者全員を招待しました。これらのワークショップへの参加は数ヶ月間堅調でした。
* 総合的な社内マーケティングキャンペーンをサポートするために、VALETラップトップステッカーやTシャツも作成しました。

すぐに会社の誰もがVALETを知っていて、SLOの私たちの新しい文化が定着し始めました。
SLOの導入でさえ、開発マネージャのためのTHDの年次パフォーマンスレビューに公式に織り込むようになりました。
毎週約50のサービスがSLOを定期的に把握して報告していましたが、メトリクスをアドホックにスプレッドシートに保存していました。
VALETのアイデアは山火事のように捉えられていましたが、私たちは広範囲の採用を促進するためにデータ収集を自動化する必要がありました。

## VALETデータ収集の自動化

私たちのSLOの文化は今では強い足場を持っていますが、VALETデータ収集の自動化はSLOの採用を加速するでしょう。

### TPSレポート

新GCP環境に展開されたサービスのVALETデータを自動的に取得するためのフレームワークを構築しました。
このフレームワークをTPSレポートと呼んでいます。これは、量とパフォーマンス(1秒あたりのトランザクション数)のテストで使用した用語であり、もちろん複数の管理者がこのデータを確認したいという考えを[からかっています](http://bit.ly/2J4bGkL)。
GCPのBigQueryデータベースプラットフォームの上にTPSレポートフレームワークを構築しました。
Webサービスを提供するフロントエンドによって生成されたすべてのログは、TPSレポートによる処理のためにBigQueryに送り込まれました。
Stackdriverによる可用性の検証など、他のさまざまな監視システムのメトリクスも含めました。

TPSレポートはこのデータを、誰でも照会できる1時間ごとのVALETメトリクスに変換しました。
新しく作成されたサービスは自動的にTPSレポートに登録されるため、すぐに照会できます。
データはすべてBigQueryに格納されているので、時間枠を超えてVALETメトリクスについて効率的にレポートできます。
このデータを使用して、さまざまな自動レポートとアラートを作成しました。
最も興味深いインテグレーションは、私たちが商用チャットプラットフォームにてVALETサービスの価値について直接報告できるようにするチャットボットでした。
例えば、過去1時間のVALET、先週と比較したVALET、SLO外のサービス、およびチャットチャネル内でのその他のさまざまな興味深いデータを表示するサービスがあります。

----------
【2】トレーニングオプションは、1時間の入門講座や半日のワークショップ、完了したら卒業式とFiREバッジが付与される熟練SREチームとのハードな4週間の集中訓練まであります。

【3】1999年の映画[オフィススペース](http://www.imdb.com/title/tt0151804/)で有名になりました。
