# 重要なイベントのアラート方法

SLOのアラートルール構成は、非常に複雑になる場合があります。
ここでは、精度、リコール、検知時間およびリセット時間の4つのパラメータを同時にうまく制御するオプションに到達するために、忠実度順で重要なイベントに関するアラートを設定する6つの方法を提示しました。
次のアプローチはそれぞれ異なる問題に対処し、いくつかは最終的に複数の問題を同時に解決します。
最初の3つの実現性のない試みは、最後の3つの実現可能なアラート戦略に向けて機能します。6つのアプローチは最も実現可能で最も推奨されるオプションです。
最初の方法は、実装は簡単ですが不十分です。一方、最適な方法は、長期的にも短期的にもSLOを守るための完全なソリューションを提供します。

この説明の目的上、「エラー・バジェット」と「エラー率」はすべてのSLIに適用されます。ただ名前に「エラー」が含まれるものだけではありません。
[20ページの「何を測定するか：SLIの使用」セクション](../../02_implementing-slos/02_02_getting-started/README.md#何を測定するか：SLIの使用)では、イベント合計に対する正常イベントの比率を収集するSLIの使用をお勧めしています。
エラー・バジェットは、許容される異常イベントの数を示し、エラー率は、合計イベントに対する異常イベントの比率です。

## 1:対象のエラー率 ≥ SLO閾値

最も簡単な解決策としては、小さな時間枠(例えば10分)を選択し、その時間枠でのエラー率がSLOを超えた場合にアラートを出すことができます。

例えば、SLOが30日間で99.9%の場合、過去10分間のエラー率が0.1%以上になったときに警告します。

    - alert: HighErrorRate
      expr: job:slo_errors_per_request:ratio_rate10m{job="myjob"} >= 0.001

この10分平均は、記録ルールを使用してPrometheusで計算されます。

    record: job:slo_errors_per_request:ratio_rate10m
    expr:
        sum(rate(slo_errors[10m])) by (job)
        　/
        sum(rate(slo_requests[10m])) by (job)

slo_errorsとslo_requestsをジョブからエクスポートしない場合、メトリックの名前を変更して時系列を作成できます。

    record: slo_errors
    expr: http_errors

最新のエラー率がSLOと等しいときにアラートすることは、システムが次のバジェットの使用を検出したことを意味します。

    アラートウィンドウサイズ/レポート期間

図5-1は、10分のアラートウィンドウと99.9%のSLOを持つサービス例の検知時間とエラー率の関係を示しています。

![アラートウィンドウが10分でSLOが99.9%のサービス例の検知時間](img/figure_5-1.png)  
図5-1. アラートウィンドウが10分でSLOが99.9%のサービス例の検知時間

表5-1に、即時エラー率が高すぎる場合のアラートの長所と短所を示します。

表5-1. 即時エラー率が高すぎる場合のアラートの長所と短所

|                                                               長所                                                               |                                                                                                                                   短所                                                                                                                                   |
| -------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| 検知時間が良い：合計停止時間は0.6秒です。このアラートは、SLOを脅かすイベントが発生したときに起動され、正常なリコールを示します。 | 精度が低い：アラートは、SLOを脅かすことのない多くのイベントで発生します。10分間のエラー率が0.1%の場合にアラートが発生し、毎月のエラー予算の0.02%のみが消費されます。極端な例を挙げると、毎日最大144個のアラートを受信し、アラートに対応することなく、SLOを達成できます。 |

## 2:アラート・ウィンドウの増加

前述の例を元に、アラート・ウィンドウのサイズを変更して精度を向上させることができます。
ウィンドウ・サイズを大きくすると、アラートをトリガーする前にバジェット額を増やすことができます。

アラートの頻度を管理しやすくするために、イベントが30日間のエラー・バジェットの5%を消費する場合(36時間以内)にのみ通知することにしました。

    - alert: HighErrorRate
       expr: job:slo_errors_per_request:ratio_rate36h{job="myjob"} > 0.001

検知時間は次のとおりです。

    (1 − SLO / error rate) × alerting window size

表5-2に、より長い時間枠でエラー率が高すぎる場合のアラートの利点と欠点を示します。

表5-2. より大きな時間枠でエラー率が高すぎる場合のアラートの長所と短所

|                                                                                               長所                                                                                                |                                                                                                                 短所                                                                                                                  |
| ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 完全な停止の場合、検出時間は2分10秒です。前の例よりも精度が向上しています。エラー率が長期間維持されるようにすることで、アラートがエラー・バジェットに対する重大な脅威となる可能性が高くなります。 | 非常に短いリセット時間:100%の停止の場合、アラートは2分後に発生し、その後36時間継続して発生します。長いウィンドウでレートを計算すると、データ・ポイントの数が多いため、メモリーまたはI/O操作の観点でコストが高くなる可能性があります。 |

図5-2に示すように、36時間のエラー率は無視できるレベルまで低下しましたが、36時間の平均エラー率はしきい値を上回ったままです。

![36時間のエラー率](img/figure_5-2.png)  
図5-2. 36時間のエラー率

## 3:アラート期間の増加

ほとんどの監視システムでは、期間パラメータをアラート基準に追加して、値がしきい値をしばらく超えない限りアラートが発生しないようにすることができます。
このパラメータは、より長いウィンドウを追加するための比較的安価な方法として使用できます。

    - alert: HighErrorRate
        expr: job:slo_errors_per_request:ratio_rate1m{job="myjob"} > 0.001
        for: 1h

表5-3に、アラートに期間パラメータを使用する利点と欠点を示します。

表5-3. アラートに期間パラメータを使用することの長所と短所

|                                                                              長所                                                                              |                                                                                                                                                                                            短所                                                                                                                                                                                            |
| -------------------------------------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------ |
| アラートの精度を上げることができます。イベント発火前にエラー率を維持する必要があるということは、アラートが重大なイベントに対応する可能性が高いということです。 | リコール率と検知時間が悪い:インシデントの重大度に応じて期間がスケールしないため、100%の停止が1時間後に警告されます。0.2%の停止が発生した場合も同様の検知時間です。100%の停止では、その時間で30日分のバジェットの140%が消費されます。メトリックが一時的にSLO内のレベルに戻ると、期間タイマーはリセットされます。SLO未達とSLO達成との間で変動するSLIは、アラートが発生しないかも知れません。 |

表5-3に示す理由から、SLOベースのアラート基準の一部として期間を使用することはお勧めしません。【1】

図5-3に、アラートが発生するまでの期間が10分のサービスの5分間の平均エラー率を示します。
エラー・バジェットの35%を消費するにもかかわらず、10分ごとに5分間継続する一連の100%のエラー・スパイクがアラートをトリガーすることはありません。

![10分ごとに100%のエラースパイクが発生するサービス](img/figure_5-3.png)  
図5-3. 10分ごとに100%のエラースパイクが発生するサービス

各スパイクは30日間のバジェットの約12%を消費しましたが、アラートはトリガーされませんでした。

----------
【1】Duration句は、非常に短い期間の一時的なノイズを除外する場合に便利です。ただし、このセクションに記載されている欠点に注意する必要があります。
