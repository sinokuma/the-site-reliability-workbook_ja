# 低トラフィックサービスとエラー・バジェットのアラート

複数ウィンドウ、複数バーンレートのアプローチは、問題が発生したときに、十分に高いレートの着信リクエストが意味のある信号を提供する場合に、うまく機能します。
ただし、これらの方法では、低いレートのリクエストを受信するシステムで問題が発生する可能性があります。
システムのユーザー数が少ないか、トラフィックが少ない(夜間や週末など)場合は、アプローチを変更する必要があります。

トラフィックの少ないサービスでは、重要でないイベントを自動的に区別するのが難しくなります。
例えば、システムが1時間に10リクエストを受信した場合、失敗したリクエストは1時間あたりのエラー率10%に相当します。
99.9%のSLOの場合、このリクエストは1,000倍のバーン・レートを構成し、30日間のエラー・バジェットの13.9%を消費するため、直ちにページャーが起動します。
このシナリオでは、30日間で失敗したリクエストは7つだけになります。
単一のリクエストが失敗する理由は、一時的でつまらないものが多いため、大規模なシステム停止と同じ方法では、必ずしもコスト効率に優れた方法での解決はできません。

最適なソリューションは、サービスの性質によって異なります。1リクエストが失敗すると、どのような影響【3】がありますか。
失敗したリクエストが1回限りで、リトライされない高い価値のリクエストの場合、高可用性の目標が適しています。
ビジネスの観点からは、失敗したすべてのリクエストを調査することが理にかなっているかも知れません。
ただし、この場合は、アラートシステムからの通知が遅すぎます。

トラフィックの少ないサービスを処理するには、いくつかの主要なオプションをお勧めします。

* 実際のユーザからのシグナル不足を補うために、人工的なトラフィックを生成します。
* 監視目的で、小さいサービスを大きいサービスに結合します。
* 次のいずれかのようにプロダクトを変更します。  
    — 1つのインシデントを失敗として認定するために、より多くのリクエストを必要とする。  
    — 単一障害のインパクトをより小さくする。

## 擬似トラフィックを生成する

潜在的なエラーや高レイテンシリクエストをチェックするために、システムはユーザアクティビティを合成することができます。
実際のユーザがいない場合、監視システムが擬似エラーやリクエストを検出できるため、オンコールエンジニアは、実際のユーザに影響が及ぶ前に問題に対処できます。

擬似トラフィックは、より多くのシグナルに対処し、既存の監視ロジックとSLOを再利用できるようにします。
ブラックボックス探索や統合テストなど、必要なトラフィック生成コンポーネントの大半をすでに保持しているかも知れません。

人工的な負荷を生成することには、いくつかの欠点があります。
SREサポートを保証するほとんどのサービスは複雑であり、大きなシステム制御側面を持っています。
理想的には、システムは、人工的なトラフィックを使用して監視するように設計および構築されるべきです。
重要なサービスであっても、ユーザのリクエストタイプの総数のごく一部しか合成できません。
ステートフルなサービスでは、状態の数が多いほど、この問題は悪化します。

さらに、問題が実際のユーザに影響を与えるが、人工的なトラフィックには影響しない場合、擬似リクエストが成功すると実際のユーザシグナルが隠されるため、ユーザがエラーを見たことは通知されません。

## サービスを結合する

複数のトラフィックの少ないサービスが1つの全体的な機能に貢献している場合、それらのリクエストを1つの上位レベルのグループにまとめると、重要なイベントをより正確かつ、より誤検知を抑制しつつ検知できます。
このアプローチが機能するためには、サービスが何らかの方法で関連付けられている必要があります。
それにより、同じプロダクトの一部を形成するマイクロサービスを結合することも、同じバイナリによって処理される複数のリクエストタイプを結合することもできます。

サービスを結合することの欠点は、個々のサービスの完全な障害が重大なイベントとしてカウントされないことです。
共通のバックエンド・データベースなどの共有障害ドメインを持つサービスを選択することで、障害がグループ全体に影響を与える可能性を高めることができます。
長期間のアラートを使用して、最終的にこれらの100%の障害を個々のサービスで検出することもできます。

## サービスとインフラストラクチャの変更

重大なイベントに関するアラートは、全てのエラー・バジェットを使い果たす前に、問題を緩和するための十分な通知を提供することを目的としています。
一時的なイベントの影響を受けにくいように監視を調整できず、擬似トラフィックの生成が実用的でない場合は、代わりにサービスを変更して、失敗した単一のリクエストによるユーザ影響を減らすことを検討してください。
たとえば、次の操作を実行できます。

* エクスポネンシャル・バックオフ・アンド・ジッターを使用して、クライアントがリトライするように変更します。【4】
* サーバまたはクライアント上で実行される最終的な実行リクエストをキャプチャするフォールバックパスを設定します。

これらの変更は、トラフィックの多いシステムで有用ですが、トラフィックの少ないシステムではさらに有用です。
エラー・バジェット内の失敗したイベントの数が多くなり、監視からのシグナルが多くなり、インシデントが重大になる前にインシデントに対応する時間が多くなります。

----------
【3】[20ページの「何を測定するか：SLIの使用」](../../02_implementing-slos/02_02_getting-started/README.md#何を測定するか：SLIの使用)セクションでは、ユーザへの影響に応じてスケールするSLI形式を推奨します。

【4】SRE サイトリライアビリティエンジニアリングの[「過負荷と障害」](http://bit.ly/2J2gqr0)を参照してください。
