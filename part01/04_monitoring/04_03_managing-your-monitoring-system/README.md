# 監視システムの管理

監視システムは、実行している他のサービスと同じくらい重要です。
したがって、適切なレベルの注意を払ってケアすべきです。

## 構成をコードとして扱う

システム構成をコードとして扱い、リビジョン管理システムに格納することは、変更履歴、特定の変更からタスク追跡システムへのリンク、簡単なロールバックとリンティング・チェック【1】、および強制的なコード・レビュー手続きなどの明確な利点をもたらす一般的な手法です。

また、監視構成をコードとして扱うことを強くお勧めします。(設定の詳細については、[第14章を](../../../part02/14_configuration-degign-and-best-practices/README.md)参照してください。)
インテントベースの構成をサポートする監視システムは、Web UIまたは[CRUD形式](http://bit.ly/1G4WdV1)のAPIのみを提供するシステムよりも適しています。
この構成方法は、構成ファイルを読み取るだけの多くのオープン・ソース・バイナリで標準的です。
[grafanalib](http://bit.ly/2so5Wrx)のようなサードパーティーのソリューションの中には、従来UIで構成されていたコンポーネントに対してこのアプローチを可能にするものもあります。

## 一貫性の促進

監視を使用するエンジニアリングチームが複数ある大規模な企業では、適切なバランスを取る必要があります。一元化されたアプローチでは一貫性が提供されますが、個々のチームが構成の設計を完全に管理する必要がある場合もあります。

適切なソリューションは組織によって異なります。
Googleのアプローチは時間の経過とともに進化し、単一のフレームワーク上でサービスとして集中的に実行されるようになりました。
この解決策は、いくつかの理由から私たちにとってうまくいきます。
単一のフレームワークを使用することで、エンジニアはチームを切り替えるときに迅速に立ち上げることができ、デバッグ中のコラボレーションが容易になります。
また、一元化されたダッシュボードサービスも提供しており、各チームのダッシュボードは検出可能でアクセス可能です。
他のチームのダッシュボードを容易に理解できる場合は、自分の問題と自分の問題の両方をより迅速にデバッグできます。

可能であれば、基本的な監視範囲を簡単に設定できます。
すべてのサービスが一貫した基本メトリクスのセットをエクスポートする場合は、組織全体でこれらのメトリクスを自動的に収集し、一貫したダッシュボードのセットを提供できます。
このアプローチでは、起動した新しいコンポーネントに基本的な監視機能が自動的に適用されます。
この監視データは、エンジニアリングチーム以外の多くのチームでも使用できます。

## 疎結合を優先する

ビジネス要件が変化し、1年後には本番システムの外観も変化します。
同様に、監視システムが監視するサービスがさまざまな障害パターンを経て進化するにつれて、監視システムも進化する必要があります。

監視システムのコンポーネントは疎結合にしておくことをお勧めします。
各コンポーネントを構成し、監視データを渡すための安定したインタフェースが必要です。
モニタリングの収集、保管、アラート、および視覚化は、それぞれ別のコンポーネントが担当する必要があります。
インターフェースが安定しているため、特定のコンポーネントをより良いものに交換することが容易になります。

オープンソースの世界では、機能を個々のコンポーネントに分割することが一般的になりつつあります。
10年前、[Zabbix](https://www.zabbix.com/)のような監視システムは、すべての機能を1つのコンポーネントにまとめました。
現代の設計では通常、収集とルール評価([Prometheus server](https://prometheus.io/)のようなソリューション)、長期時系列ストレージ([InfluxDB](https://www.influxdata.com/))、アラート集約([Alertmanager](http://bit.ly/2soB22b))、およびダッシュボード([Grafana](https://grafana.com/))を分離します。

----------
【1】例えば、promtoolを使用してPrometheus構成が構文的に正しいことを確認します。

【2】OpenCensusのような計装フレームワークや、Istioのようなサービス・メッシュなどの共通ライブラリを介して、基本的なメトリクスをエクスポートすることができます。
