# 目的のあるメトリクス

[第5章](../../05_alerting-on-slos/README.md)では、システムのエラーバジェットが脅威にさらされているときに、SLIメトリクスを使って監視およびアラートを行う方法について説明します。
SLIメトリクスは、SLOベースのアラートがトリガーされたときに最初にチェックするメトリクスです。
これらの指標は、サービスのダッシュボード、理想的にはランディングページに目立つように表示されます。

SLO違反の原因を調査しても、SLOダッシュボードから十分な情報が得られないことがほとんどです。
これらのダッシュボードは、SLOに違反していることを示していますが、必ずしもその理由を示しているわけではありません。
監視ダッシュボードには、他にどのようなデータを表示する必要がありますか。

メトリクスの実装には、次のガイドラインが役立ちます。
これらのメトリクスは、本番環境の問題を調査し、サービスに関する広範な情報を提供するための合理的な監視を提供する必要があります。

## 予定された変更

SLOベースのアラートを診断する場合は、ユーザーに影響を与える問題を通知するアラートメトリクスから、問題の原因を示すメトリクスに移行できる必要があります。
最近予定されたサービスの変更が原因である可能性があります。
本番環境の変更を通知する監視機能を追加します。【4】
トリガーを決定するには、次のことを推奨します。

* バイナリのバージョンを監視します。
* 特にこれらのフラグを使用してサービスの機能を有効または無効にする場合は、コマンドラインフラグを監視します。
* 構成データがサービスに動的にプッシュされる場合は、この動的構成のバージョンを監視します。

これらのシステムのいずれかがバージョン管理されていない場合は、システムが最後に構築またはパッケージされたときのタイムスタンプを監視できます。

機能停止をロールアウトと相関させようとする場合、アラートからリンクされたグラフやダッシュボードを見る方が、CI/CD(継続的インテグレーション/継続的デリバリ)システムログを追跡するよりもずっと簡単です。

## 依存関係

サービスが変更されていない場合でも、サービスの依存関係が変更されたり、問題が発生したりする可能性があるため、直接的な依存関係からの応答も監視する必要があります。

依存関係ごとに、リクエストとレスポンスのサイズ(バイト単位)、レイテンシ、およびレスポンスコードをエクスポートすることをお勧めします。
グラフ化するメトリクスを選択するときは、4つの[ゴールデンシグナル](http://bit.ly/2LSLpDQ)を念頭に置いてください。
メトリクスに追加のラベルを使用して、レスポンスコード、RPC(リモートプロシージャコール)メソッド名、ピアジョブ名で細分化できます。

理想的には、各RPCクライアントライブラリにメトリクスのエクスポートを依頼するのではなく、これらのメトリクスを一度エクスポートするように下位レベルのRPCクライアントライブラリを計装できます。【5】
クライアントライブラリを計装すると、一貫性が向上し、新しい依存関係を無料で監視することができます。

非常に限定されたAPIを提供する依存関係に出くわすことがありますが、その場合にはGetやQueryなどと呼ばれる単一のRPCですべての機能を利用することができ、実際のコマンドはこのRPCの引数として指定されます。
この種の依存関係では、クライアントライブラリ内の1つの計装ポイントでは不十分です。レイテンシの変動が大きく、この不透明なAPIの一部が完全に失敗しているかどうかを示すエラーの割合が高くなります。
この依存性が重要な場合は、それを適切に監視するためのオプションがいくつかあります。

* 別のメトリクスをエクスポートして依存性を調整し、メトリクスが受信したリクエストをアンパックして実際のシグナルを取得できるようにします。
* 別のRPCサービスとメソッドに分割された別の機能をサポートする、より広範なAPIをエクスポートするために、依存関係の所有者に書き直しを依頼してください。

## サチュレーション

サービスが依存するすべてのリソースの使用状況を監視および追跡することを目的とします。
アプリケーションに割り当てられたRAM、ディスク、CPUクォータなど、一部のリソースには、超えてはならないハード制限があります。
その他のリソース(オープンファイルディスクリプタ、スレッドプール内のアクティブスレッド、キュー内の待機時間、書き込まれたログの量など)には明確なハード制限はありませんが、管理は必要です。

使用しているプログラミング言語に応じて、次の追加リソースを監視する必要があります。

* Javaの場合:ヒープと[メタスペース](http://bit.ly/2J9g3Ha)のサイズ、使用しているガベージコレクションのタイプに応じたより具体的なメトリクス
* Goの場合:goroutineの数

言語自体は、これらのリソースを追跡するためのさまざまなサポートを提供します。

[第5章](../../05_alerting-on-slos/README.md)で説明した重要なイベントのアラートに加えて、次のような特定のリソースの枯渇に近づいたときに起動するアラートも設定する必要があります。

* リソースにハード制限がある場合
* 使用率のしきい値を超えるとパフォーマンスが低下する場合

監視メトリクスを使用して、すべてのリソース(サービスが適切に管理しているリソースも含む)を追跡する必要があります。
これらのメトリクスは、キャパシティプランニングやリソースプランニングに不可欠です。

## 対象トラフィックのステータス

ダッシュボードがステータスコード(ただし、サービスがSLIの目的で使用するメトリクスにすでにこの情報が含まれている場合を除く)ごとに対象トラフィックを分類できるように、メトリクスまたはメトリックラベルを追加することをお勧めします。
次にいくつかの推奨事項を示します。

* HTTPトラフィックの場合は、すべての応答コードを監視します。これは、応答コードがアラートを生成するための十分な信号を提供しない場合でも同様です。一部の応答コードは、クライアントの誤った振舞いによってトリガーされる可能性があるためです。
* ユーザーにレート制限またはクォータ制限を適用する場合は、クォータ不足のために拒否されたリクエストの総数を監視します。

このデータのグラフは、本番環境変更中にエラーの量が顕著に変化するタイミングを識別するのに役立ちます。

## 目的に沿ったメトリクス実装

公開された各メトリックには目的があります。
メトリクスの生成が容易であるという理由だけで、少数のメトリックをエクスポートする誘惑に負けないようにします。
その代わりに、これらのメトリクスがどのように使用されるかを考えてください。
メトリック設計、またはその欠如は、意味を持ちます。

理想的には、アラートに使用されるメトリック値は、システムが問題状態になったときにのみ劇的に変化し、システムが正常に動作しているときには変化しません。
一方、デバッグ用のメトリクスにはこれらの要件はありません。これらの要件は、アラートがトリガーされたときに何が発生しているかを把握するためのものです。
優れたデバッギングメトリクスは、問題を引き起こす可能性のあるシステムのある側面を示します。
事後分析を行う際には、どのメトリクスを追加すれば問題をより迅速に診断できるかを考えてください。

----------
【4】これは、ログによる監視が魅力的なケースの1つです。特に、本番環境の変更が比較的少ないからです。ログとメトリクスのどちらを使用する場合でも、これらの変更はダッシュボードに表示されるため、本番の問題をデバッグする際に簡単にアクセスできます。

【5】これを提供するライブラリのセットについては、[https://opencensus.io/](https://opencensus.io/)を参照してください。
