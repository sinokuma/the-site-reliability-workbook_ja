# 目的のあるメトリクス

[第5章](../../05_alerting-on-slos/README.md)では、システムのエラーバジェットが脅威にさらされているときに、SLIメトリクスを使って監視およびアラートを行う方法について説明します。
SLIメトリクスは、SLOベースのアラートがトリガーされたときに最初にチェックするメトリクスです。
これらの指標は、サービスのダッシュボード、理想的にはランディングページに目立つように表示されます。

SLO違反の原因を調査しても、SLOダッシュボードから十分な情報が得られないことがほとんどです。
これらのダッシュボードは、SLOに違反していることを示していますが、必ずしもその理由を示しているわけではありません。
監視ダッシュボードには、他にどのようなデータを表示する必要がありますか。

メトリクスの実装には、次のガイドラインが役立ちます。
これらのメトリクスは、本番環境の問題を調査し、サービスに関する広範な情報を提供するための合理的な監視を提供する必要があります。

## 予定された変更

SLOベースのアラートを診断する場合は、ユーザーに影響を与える問題を通知するアラートメトリクスから、問題の原因を示すメトリクスに移行できる必要があります。
最近予定されたサービスの変更が原因である可能性があります。
本番環境の変更を通知する監視機能を追加します。【4】
トリガーを決定するには、次のことを推奨します。

* バイナリのバージョンを監視します。
* 特にこれらのフラグを使用してサービスの機能を有効または無効にする場合は、コマンドラインフラグを監視します。
* 構成データがサービスに動的にプッシュされる場合は、この動的構成のバージョンを監視します。

これらのシステムのいずれかがバージョン管理されていない場合は、システムが最後に構築またはパッケージされたときのタイムスタンプを監視できます。

機能停止をロールアウトと相関させようとする場合、アラートからリンクされたグラフやダッシュボードを見る方が、CI/CD(継続的インテグレーション/継続的デリバリ)システムログを追跡するよりもずっと簡単です。

## 依存関係

サービスが変更されていない場合でも、サービスの依存関係が変更されたり、問題が発生したりする可能性があるため、直接的な依存関係からの応答も監視する必要があります。

依存関係ごとに、リクエストとレスポンスのサイズ(バイト単位)、レイテンシ、およびレスポンスコードをエクスポートすることをお勧めします。
グラフ化するメトリクスを選択するときは、4つの[ゴールデンシグナル](http://bit.ly/2LSLpDQ)を念頭に置いてください。
メトリクスに追加のラベルを使用して、レスポンスコード、RPC(リモートプロシージャコール)メソッド名、ピアジョブ名で細分化できます。

理想的には、各RPCクライアントライブラリにメトリクスのエクスポートを依頼するのではなく、これらのメトリクスを一度エクスポートするように下位レベルのRPCクライアントライブラリを計装できます。【5】
クライアントライブラリを計装すると、一貫性が向上し、新しい依存関係を無料で監視することができます。

非常に限定されたAPIを提供する依存関係に出くわすことがありますが、その場合にはGetやQueryなどと呼ばれる単一のRPCですべての機能を利用することができ、実際のコマンドはこのRPCの引数として指定されます。
この種の依存関係では、クライアントライブラリ内の1つの計装ポイントでは不十分です。レイテンシの変動が大きく、この不透明なAPIの一部が完全に失敗しているかどうかを示すエラーの割合が高くなります。
この依存性が重要な場合は、それを適切に監視するためのオプションがいくつかあります。

* 別のメトリクスをエクスポートして依存性を調整し、メトリクスが受信したリクエストをアンパックして実際のシグナルを取得できるようにします。
* 別のRPCサービスとメソッドに分割された別の機能をサポートする、より広範なAPIをエクスポートするために、依存関係の所有者に書き直しを依頼してください。

----------
【4】これは、ログによる監視が魅力的なケースの1つです。特に、本番環境の変更が比較的少ないからです。ログとメトリクスのどちらを使用する場合でも、これらの変更はダッシュボードに表示されるため、本番の問題をデバッグする際に簡単にアクセスできます。

【5】これを提供するライブラリのセットについては、[https://opencensus.io/](https://opencensus.io/)を参照してください。
