# 実例

図2-1に示すように、携帯電話ゲームの単純化されたアーキテクチャを考えてみましょう。

![携帯電話ゲームのアーキテクチャ例](img/figure_2-1.png)  
図2-1. 携帯電話ゲームのアーキテクチャ例

ユーザの携帯電話で実行されているアプリは、クラウド上で実行されているHTTPのAPIと対話します。
APIは状態の変更を永続的なストレージシステムに書き込みます。
このデータに対してパイプラインが定期的に実行され、今日、今週、総合でハイスコアを提供するリーグ表を生成します。
このデータは独立したリーグ表データストアに書き込まれ、結果はモバイルアプリ(ゲーム内スコア用)およびWebサイトから利用できます。
ユーザは、APIを介したゲーム内でもハイスコアWebサイトでも使用されるカスタムアバターをユーザデータテーブルにアップロードできます。

この設定であると仮定した場合、ユーザがシステムとどのようにやり取りするのか、そしてどのようなSLIがユーザエクスペリエンスのさまざまな側面を測定するのかを考えることができます。

これらのSLIの一部は重複することがあります。リクエスト駆動型サービスには正確性のSLIがあり、パイプラインには可用性のSLIがあり、耐久性のSLIは正確性のSLIの変形として見られることがあります。
顧客にとって最も重要な機能を表す少数(5つ以下)のSLIタイプを選択することをお勧めします。

典型的なユーザエクスペリエンスとロングテールの両方を把握するために、一部のタイプのSLIには複数段階のSLOを使用することも推奨します。
例えば、ユーザからのリクエストの90％が100ミリ秒以内に返却されるが、残りの10％が10秒かかる場合、多くのユーザは不幸になるでしょう。
レイテンシのSLOは、複数の閾値を設定することでこのユーザベースをとらえることができます。リクエストの90％は100ミリ秒より速く、リクエストの99％は400ミリ秒より速いといった具合です。
この原則は、ユーザの不幸を測定するパラメータを持つすべてのSLIに適用されます。

表2-1に、さまざまな種類のサービスに共通のSLIを示しています。

表2-1. さまざまな種類のコンポーネントに対する潜在的なSLI

| サービスタイプ | SLIタイプ | 説明 |
| --- | --- | --- |
| リクエスト駆動 | 可用性 | 応答が成功したリクエストの割合。 |
| リクエスト駆動 | レイテンシ | ある閾値よりも速いリクエストの割合。 |
| リクエスト駆動 | 品質 | 過負荷のときやバックエンドが利用できないときにサービスが適切に劣化した場合は、劣化していない状態で処理された応答の割合を測定する必要があります。例えば、ユーザデータストアが利用できない場合でも、ゲームはプレイ可能ですが一般的な画像が使用されます。 |
| パイプライン | 新鮮性 | ある閾値よりも最近に更新されたデータの割合。理想的には、このメトリクスはユーザエクスペリエンスを最も正確に反映するために、ユーザがデータにアクセスした回数をカウントします。 |
| パイプライン | 正確性 | パイプラインに入ってくる正しい値が出力されたレコードの割合。 |
| パイプライン | カバレッジ | バッチ処理の場合は、とある目標データ量を超えて処理したジョブの割合。ストリーミング処理の場合は、一定の時間枠内に正常に処理された受信レコードの割合。 |
| ストレージ | 耐久性 | 正常に読み取り可能な書き込まれたレコードの割合。耐久性SLIには特に注意してください。ユーザが望むデータは、格納されているデータのごく一部に過ぎないかも知れません。例えば、過去10年間に10億件のレコードがあり、ユーザが今日のレコードだけを入手したい場合(そして利用できない場合)、それらのデータのほとんどすべてが読み取り可能であっても不幸になります。 |

## SLI仕様からSLI実装への移行

SLI仕様を理解したならば、次にそれらを実装する方法について考え始める必要があります。

最初のSLIには、最小限のエンジニアリング作業を必要とするものを選択してください。
Webサーバのログはすでに利用可能であるが、調査の設定に数週間、JavaScriptの活用に数ヶ月かかる場合、ログを使用してください。

SLIを測定するには十分な情報が必要です。可用性には、成功/失敗ステータスが必要です。遅延リクエストの場合は、リクエストの処理時間が必要です。
この情報を記録するようにWebサーバを再設定する必要があるかもしれません。
クラウドベースのサービスを使用している場合は、この情報の一部がモニタリングダッシュボードで既に利用可できるようになっている可能性があります。

私たちのサンプルアーキテクチャのSLI実装にはさまざまなオプションがあり、各々、長所と短所があります。
次のセクションでは、私たちのシステムの3種類のコンポーネントのSLIについて詳しく説明します。
