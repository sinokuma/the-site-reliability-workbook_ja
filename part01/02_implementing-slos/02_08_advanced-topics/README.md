# 高度なトピック

健全で成熟したSLOとエラー・バジェット文化が根付いたならば、サービスの信頼性をどのように測定して議論するかを継続的に改善および洗練することができます。

## ユーザジャーニーのモデリング

この章で説明するすべてのテクニックは組織にとって有益なものですが、最終的にはSLOはカスタマーエクスペリエンスの向上に重点を置くべきです。
したがって、ユーザ中心のアクションという観点からSLOを書く必要があります。

顧客の経験を捉えるのに役立てるために、重要なユーザジャーニーを使うことができます。
重要なユーザジャーニーは、特定のユーザエクスペリエンスの中核部分であり、サービスの重要な側面である一連のタスクです。
例えば、オンラインショッピングでは、重要なユーザジャーニーは次のようになると思われます。

* 商品の検索
* ショッピングカートに商品を追加
* 購入完了

これらのタスクはほぼ確実に既存のSLIにうまくマッピングされません。各タスクは、どの箇所でも失敗する可能性がある複数かつ複雑なステップを必要とし、ログからこれらのアクションの成功(または失敗)を推測することは非常に困難な可能性があります。(例えば、第3ステップでユーザが失敗したのか、または別のタブで猫の動画に気を取られただけなのかをどのように決定しますか。)
ただし、サービスの側面が信頼できるものであることを確認する前に、ユーザにとって重要なことを特定する必要があります。

ユーザ中心のイベントを特定したら、それらを測定するという問題を解決できます。
個別のログイベントを統合したり、高度なJavaScriptプロービングを使用したり、クライアントサイド実装を使用したり、その他のプロセスを使用してそれらを測定するでしょう。
イベントを測定できるようになると、それは別個のSLIになり、既存のSLIおよびSLOと一緒に追跡できます。
重要なユーザジャーニーはあなたの精度に影響を与えることなくリコールを向上させることができます。

## 格付けインタラクションの重要性

すべてのリクエストが等しいと見なされるわけではありません。
アカウント通知(日次パイプラインによって通知が生成される)をチェックするモバイルアプリからのHTTPリクエストは、ユーザにとって重要ですが、広告主による請求関連のリクエストほど重要ではありません。

特定の種類のリクエストを他の種類のリクエストと区別する方法が必要です。
これを実現するためにバケットを使用することができます。つまり、SLIにラベルを追加して、それらのラベルに異なるSLOを適用します。
表2-6に例を記載します。

表2-6. 層によるバケッティング

| 顧客層    | 可用性SLO |
| -------- | -------- |
| プレミアム | 99.99%   |
| 無料      | 99.9%    |

表2-7に示すように、期待されている応答性によってリクエストを分割できます。

表2-7. 期待されている応答性によるバケッティング

| 応答性                                           | レイテンシSLO                        |
| ----------------------------------------------- | ---------------------------------- |
| インタラクティブ(ページ読込みをブロックするリクエスト等) | リクエストの90%が100ミリ秒以内に完了する |
| CSVダウンロード                                   | ダウンロードの90%が5秒以内に開始する     |

SLOを各顧客に個別に適用するために利用可能なデータがある場合は、いつでもSLO内の顧客数を追跡できます。
この数は非常に変動しやすいことに注意してください。非常に少ない数のリクエストを送信する顧客は、100％の可用性(障害を体験しないほど幸運だったため)または非常に低い可用性(経験した1つの障害がか彼らのリクエストのかなりの割合を占めたため)を得るでしょう。
個々の顧客がつまらない理由でSLOを満たすことができない可能性がありますが、まとめると、多数の顧客のSLO遵守に影響する問題を追跡することは有益なシグナルになることがあります。

## 依存関係をモデリングする

大規模システムには多くのコンポーネントがあります。
単一のシステムには、プレゼンテーション層、アプリケーション層、ビジネスロジック層、およびデータ永続化層があります。
これらの各層は、多くのサービスまたはマイクロサービスで構成されています。

最大の関心事はスタック全体をカバーするユーザ中心のSLOを実装することですが、SLOはスタック内の異なるコンポーネント間で信頼性要件を調整して実装するのにも便利な方法です。

例えば、単一のコンポーネントが特に価値の高いインタラクションにとって重要な依存関係【9】を持っている場合、その信頼性の保証は少なくとも依存するアクションの信頼性の保証と同程度高くあるべきです。
その特定のコンポーネントを運営するチームは、包括的なプロダクトSLOと同じ方法で、そのサービスのSLOを所有および管理する必要があります。

特定のコンポーネント固有の信頼性制限がある場合、SLOはその制限を伝えることができます。
それに依存するユーザジャーニーが、そのコンポーネントが合理的に提供することができるレベルよりも高いレベルの可用性を必要とする場合、あなたはその条件を中心に設計する必要があります。
別のコンポーネントを使用するか、そのコンポーネントの障害に対処するために十分な防御策(キャッシング、オフラインのストアアンドフォワード処理、グレースフルデグレーション等)を追加することができます。

これらの問題からあなたの方法を数学的に考えようと試みるのは魅力的かもしれません。
単一ゾーンで99.9％の可用性を提供するサービスがあり、99.95％の可用性が必要な場合は、2つのゾーンにサービスをデプロイするだけでその要件を解決することができます。
両方のサービスが同時に停止する確率は非常に低いため、2つのゾーンで99.9999％の可用性を提供すべきです。
しかしながら、この推論は両方のサービスが完全に独立していることを想定しており、ほとんどそのようなケースはありません。
アプリケーションの2つのインスタンスには、共通の依存関係、共通の障害ドメイン、共有された運命、およびグローバルコントロールプレーンがあります。
これらはすべて、慎重に設計および管理されているにもかかわらず、両方のシステムで機能停止を引き起こす可能性があります。
これらの依存関係と障害パターンの各々が注意深く列挙され、説明されていない限り、そのような計算は人の目を欺くことになるでしょう。

障害が、他チームが処理している依存関係によって引き起こされた場合、どうやってエラー・バジェットポリシーが失敗したSLOに対処すべきかということについて2つの考え方があります。

* システムが問題を引き起こさなかったように、チームもリリースを停止したり、信頼性にもっと時間を費やしたりすべきではありません。
* 停止の原因にかかわらず、将来的な機能停止の可能性を最小限に抑えるために、変更の凍結を制定すべきです。

2番目の方法はユーザをより幸せにするでしょう。
この原則をどのように適用するかいくらか柔軟性があります。
機能停止や依存関係の性質によっては、変更の凍結は現実的ではない場合があります。
あなたのサービスとその依存関係に最も適したものを決定し、その決定を後世のために文書化されたエラー・バジェットに記録してください。
これが実際にどのように機能するかの例については、[付録B](../../../23_appendix/examples-error-budget-policy/README.md)のエラー・バジェットポリシーの例を参照してください。

## SLOを緩和させて試験する

アプリケーションの信頼性を試験して、信頼性におけるどの変更(ページの読み込み時間にレイテンシを追加する等)がユーザの行動にかなり悪影響を及ぼすか(例えば、購入を完了したユーザ割合)を測定することができます。
消費できるエラー・バジェットがあると確信できる場合にのみ、この種の分析を実行することをお勧めします。
レイテンシ、可用性、顧客、ビジネスドメイン、および競合(またはそれらの欠如)の間には、多くの微妙な相互作用があります。
意識されているカスタマーエクスペリエンスを故意に低下させる選択をすることは、仮にあったとしても非常に思い切った手段です。

この行動は怖いように思えるかもしれませんが(誰も売上を落としたくないので！)、このような試験を行うことで得られるナレッジによって、将来更なるパフォーマンス向上(そして、売上高向上)に導くことができる方法でサービスを改善することができるでしょう。
このプロセスによって、主要なビジネス指標(売上等)と測定可能な技術指標(レイテンシ等)の関係を数学的に識別することができるでしょう。
もしそうなら、あなたは今後のサービスの重要なエンジニアリング意思決定をするために利用できる非常に貴重なデータを得ることになります。

この行動は1回限りのアクティビティではありません。
サービスが進化するにつれて、顧客の期待も変わります。
関係の継続的な有効性を定期的にレビューするようにしてください。

----------
【9】利用できないということがサービスも利用できないことを意味する場合、依存関係は重要です。
